---
title: "Glioma TIME signature matrix"
author: "Andrew Lindsay"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    number_sections: true
---

# Creating a glioma tumor immune microenvironment (TIME) cell signature matrix

First, setup the environment. This gets all the directories, loads the scripts, and creates the necessary objects (cell types, probes, chains).

```{r, include=FALSE}
proj_dir <- getwd()
script_dir <- paste0(proj_dir,"/R/")
image_dir <- paste0(proj_dir,"/images/")

data_dir <- paste0(proj_dir,"/data/")
dataset_dir <- paste0(data_dir,"/datasets/")
analysis_dir <- paste0(data_dir,"/analysis/")
sig_dir <- paste0(data_dir,"/signatures/")

#mkdirs(home_dir, data_dir, image_dir, exp_dir, script_dir, dataset_dir, sig_dir)

source(paste0(script_dir,"/setup_env.R"))
setupEnv(script_dir, sig_dir)

stopifnot(exists("probes"))
stopifnot(exists("cell_types"))
stopifnot(exists("chains"))

useCairo <- T
```

Next, create a merged object containing all the cells used to generate the signature matrix.

```{r, message=FALSE, warning=FALSE}
exp_dir <- paste0(analysis_dir,"deconvolution/")
exp_name <- "glioma_tme_sigmtx"
mkdirs(exp_dir)

cells <- c("Bcell", "CD4Tcell", "CD8Tcell", "Treg", "NKcell",
           "Microglia", "Dendritic", "Monocyte","Granulocyte", "Neuron", "Glia", "Glioma",
           "Endothelial")

exps <- c("singh","GSE35069","GSE49667","GSE66351",
          "GSE83458","GSE88824","GSE103211","GSE128654","GSE144804")#,"GSE151506.mgsig")

# cells <- c("Granulocyte", "CD4Tcell", "CD8Tcell", "Monocyte",#"WholeBlood", 
           # "Bcell", "NKcell")

#cells <- c("Microglia", "Monocyte")

scm <- get_data_set(dataset_dir = dataset_dir, GEO = exps, regions = "proms.hg38", merge = TRUE, cells = cells)

scm
table(colData(scm)$Cell)
```

## Feature selection:

### Find significant features

This uses methylCIBERSORT to identify differentially methylated probes (DMPs) that distinguish each cell type. See [here](https://github.com/dannlbol/mcibersort_scripts) for a description of the output files.

```{r, eval=FALSE}
setwd(exp_dir)

DMPs = 200
set.seed("123")

k = round(sqrt(ncol(scm))/2)
if((k %% 2) == 0) k = k+1
message("k = ",k)

scm <- impute_regions(scm,k=k)
names(rowRanges(scm)) <- paste0("rid_",1:nrow(scm))
scm.features <- do_methylcibersort(scm, assay="impute",MaxDMPs = DMPs, deltaBeta = 0.25, output.dir = exp_dir)
metadata(scm.features)["top_features_selected"] <- DMPs

feats.top <- rowRanges(scm.features)
saveRDS(feats.top,paste0(exp_dir, "methylCibersort_0.25_", DMPs, "_rowRanges.rds"))

file.sigmtx <- list.files(exp_dir, full.names = TRUE, pattern = paste0(".*",DMPs,"_Signature.txt$"), ignore.case = T)
file.features <- paste0("methylCibersort_0.25_",DMPS,"_rowRanges.rds")
```

### Generate cell spatial plot

This generate a dimensionality reduction of the signature matrix. It should have discrete groupings of each cell type, with super clusters of closely related cells (e.g., leukocytes).

```{r, eval=FALSE}
# Graph the features ----------------------------------------------------------------------------------------------
scm.features <- dim_red_scMethrix(scm.features,type="tSNE",assay="impute",perplexity=65,max_iter=2000)
glioma_tme_features_tSNE <- plot_dim_red(scm.features,"tSNE",color_anno="Cell",axis_labels=list(X="tSNE1",Y="tSNE2"),
                       base_size=20,legend.title = element_blank(),legend.position = "none",
                       legend.margin=margin(5,5,5,5),
                       legend.box.margin=margin(-18,0,0,0),
                       legend.box.background = element_blank(),
                       legend.background = element_blank(),
                       legend.text=element_text(size=14))
glioma_tme_features_tSNE

if (useCairo) {
  Cairo::Cairo(file=paste0(images_dir, exp_name, "_tSNE_", get_timestamp(), ".png"),
               type="png", units="px", width=500, height=500, pointsize=24, dpi="auto")
  glioma_tme_features_tSNE
  dev.off()
} 
```

### Generate epigenetic heatmap

This graphs the respective epigenome of each sample. Red is methylated and blue in unmethylated.

```{r, eval=FALSE}

generate_heatmap <- function(scm,assay = "score", grouping = NULL, n_cpg = NULL,...) {
  
  if (!is.null(n_cpg)) scm <- reduce_scMethrix(scm,assay=assay,n_cpg = n_cpg,var="rand")
  
  mat <- as.matrix(get_matrix(scm,assay))
  type <- colData(scm)$Cell
  # ha = HeatmapAnnotation(
  #   df = data.frame(type = type),
  #   foo = anno_block(gp = gpar(fill = get_palette(length(unique(colData(scm)$Cell))))),
  #   annotation_height = unit(8, "mm"),gp = gpar(col = "black")
  # )

  mg_idx <- which(type == "Microglia")
  mgs <- mat[,mg_idx,drop=FALSE]
  
  mat <- cbind(mat,mgs[,rep(1,5)])
  type <- append(type,rep("Microglia",5))

  Heatmap(mat, name = "Î²-value", km = 5, column_title_rot = 90, border = TRUE,#top_annotation = ha,
          column_split = type,
          #column_names_gp = 14,#cluster_columns = agnes(t(mat)), 
          row_dend_reorder = TRUE,
          show_row_names = FALSE, row_title = NULL, column_dend_side = "bottom", column_names_side = "top", show_column_names = FALSE,...)
  
}

glioma_tme_features_hmap <- generate_heatmap(scm.features,assay="impute")
#hmap <- generate_heatmap(scm,assay="impute")
glioma_tme_features_hmap

if (useCairo) {
  Cairo::Cairo(file=paste0(images_dir, exp_name, "_hmap_", get_timestamp(), ".png"),
               type="png", units="px", width=500, height=500, pointsize=20, dpi="auto")
  draw(glioma_tme_features_hmap, padding = unit(c(2, 2, 10, 2), "mm"))
  dev.off()
}
```

## Evaluation signature matrix

### Compare synthetic mix of pure samples from [GSE110554](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE110554)

Synthetic mixtures for known proportions of pure samples are generated and compared to the signature matrix from above. If the signature matrix is accurate, CIBERSORT should show similar proportions of cell types in each synthetic mixture.

```{r, eval=FALSE}

feats.top <- readRDS(file.features)
scm <- get_data_set(c("GSE110554"), cells = cells)
scm <- bin_scMethrix(scm,regions = feats.top,fill=T)
scm <- impute_regions(scm,k=7)
names(rowRanges(scm)) <- names(feats.top)
betas <- get_matrix(scm,assay="impute")
sig.mtx <- read.delim(file.sigmtx, row.names = 1, header = TRUE)
#row.names(b.sig) <- paste0("id",1:nrow(b.sig))
betas <- betas[rownames(sig.mtx), ]
make.synth.mix(input.data = betas*100,
               pop.factor = as.factor(colData(scm)$Cell),
               pop.rows = 10,
               n.cores = 1,
               output.name = "glioma_tme")

file.synmix <- list.files(getwd(), full.names = TRUE, pattern = ".*glioma_tme_synth_mix.txt$", ignore.case = T)
file.synprop <- list.files(getwd(), full.names = TRUE, pattern = ".*glioma_tme_synth_prop.txt$", ignore.case = T)

scm.synmix <- scm
```

```{r, eval=FALSE}
sig.mtx = read.delim(file.sigmtx, row.names = 1, header = TRUE)
syn.mix = read.delim(file.synmix, row.names = 1, header = TRUE, sep="\t")

stopifnot(rownames(syn.mix) == rownames(sig.mtx))

results <- CIBERSORT(sig_matrix = sig.mtx,
                     mixture_file = syn.mix,
                     perm = 200,
                     QN = TRUE,
                     absolute = FALSE,
                     abs_method = 'sig.score')
```

```{r, eval=FALSE}
props <- read.delim(file.synprop, header = TRUE,sep=" ")
row.names(props) <- paste0("synth.",1:nrow(props))

stats <- results[,(ncol(results)-2):ncol(results)]
scores <- as.matrix(results)[,1:(ncol(results)-3)]

scores <- scores[,colnames(props)]

props.melt <- setNames(reshape2::melt(as.matrix(props)), c('Mix', 'Cell', 'X'))
scores.melt <- setNames(reshape2::melt(scores), c('Mix', 'Cell', 'Y'))

syn.stats <- merge(scores.melt,props.melt,by=c("Mix","Cell"))
syn.stats$X <- round(syn.stats$X,3)
syn.stats$Y <- round(syn.stats$Y,3)

corr <- cor.test(c(as.matrix(props)), c(as.matrix(scores)), method="pearson")
corr.lbl <- paste("Spearman R = ",round(corr$estimate,3),"\np << 0.001")


prop.vec <- c(as.matrix(props))
res.vec <- c(as.matrix(scores))

glioma_tme_sigmtx_pure_corr <- ggplot(syn.stats, aes(x=X, y=Y,fill = Cell)) + geom_point(shape = 21, size =2, alpha = .7) + 
  geom_abline(intercept = 0, slope = 1) + annotate("text", x=0.35, y=0.75, label=corr.lbl) +xlab("Synthetic Proportion") + ylab("Calculated Proportion") + scMethrix_theme(base_size=20,legend.text=element_text(size=16))
glioma_tme_sigmtx_pure_corr

if (useCairo) {
  Cairo::Cairo(file=paste0(images_dir,exp_name,"_pure_sample_correlation_",get_timestamp(),".png"),
               type="png", units="px", width=500, height=300, pointsize=20, dpi="auto")
  glioma_tme_sigmtx_pure_corr
  dev.off()
}
```

### Compare PBMCs from [GSE112618](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE112618)

Similar to above, further evaluation is done with PBMC samples. Instead of a synthetic mixture of cells, these samples have known cell proportions as per flow cytometry.

```{r, eval=FALSE}
feats.top <- readRDS(file.features)
scm <- get_data_set(c("GSE112618"))
scm <- bin_scMethrix(scm,regions = feats.top,fill=T)
scm <- impute_regions(scm,k=2)
scm <- scm[,which(colData(scm)$Cell == "ImmMix")]
names(rowRanges(scm)) <- names(feats.top)
betas <- get_matrix(scm,assay="impute")
sig.mtx <- read.delim(file.sigmtx, row.names = 1, header = TRUE)
#row.names(b.sig) <- paste0("id",1:nrow(b.sig))
betas <- betas[rownames(sig.mtx), ]*100
betas <- as.data.frame(betas)
results.pbmc <- CIBERSORT(sig_matrix = sig.mtx,
                     mixture_file = betas,
                     perm = 100,
                     QN = FALSE,
                     absolute = FALSE,
                     abs_method = 'sig.score')
```

```{r, eval=FALSE}
file.mixprop <- paste0(dataset_dir,"\\GSE112618\\GSE112618_cellmix.tsv")
props <- read.delim(file.mixprop, header = TRUE,sep="\t",row.names=1)

stats <- results[,(ncol(results)-2):ncol(results)]
scores <- as.matrix(results)[,1:(ncol(results)-3)]

scores <- data.frame(scores[,colnames(props)])

props.melt <- setNames(reshape2::melt(as.matrix(props)), c('Mix', 'Cell', 'X'))
scores.melt <- setNames(reshape2::melt(as.matrix(scores)), c('Mix', 'Cell', 'Y'))

syn.stats <- merge(scores.melt,props.melt,by=c("Mix","Cell"))
syn.stats$X <- round(syn.stats$X,3)
syn.stats$Y <- round(syn.stats$Y,3)

corr <- cor.test(c(as.matrix(props)), c(as.matrix(scores)), method="pearson")
corr.lbl <- paste("Spearman R = ",round(corr$estimate,3),"\np << 0.001")

prop.vec <- c(as.matrix(props))
res.vec <- c(as.matrix(scores))

glioma_tme_sigmtx_mixed_corr <- ggplot(syn.stats, aes(x=X, y=Y,fill = Cell)) + geom_point(shape = 21, size =2, alpha = .7) + 
  geom_abline(intercept = 0, slope = 1) + annotate("text", x=0.35, y=0.6, label=corr.lbl) +xlab("Synthetic Proportion") + ylab("Calculated Proportion") + scMethrix_theme(base_size=20,legend.text=element_text(size=16),legend.background=element_blank())
glioma_tme_sigmtx_mixed_corr

if (useCairo) {
  Cairo::Cairo(file=paste0(images_dir,exp_name,"_mixed_sample_correlation_",get_timestamp(),".png"),
               type="png", units="px", width=500, height=300, pointsize=20, dpi="auto")
  glioma_tme_sigmtx_mixed_corr
  dev.off()
}

scores.melt <- scores
scores.melt$Type <- "Act"
scores.melt$Exp <- row.names(scores.melt)

props.melt <- props
props.melt$Type <- "Calc"
props.melt$Exp <- row.names(props.melt)

props.melt <- setNames(reshape2::melt(props.melt), c('Type', 'Exp', 'Cell', "Value"))
scores.melt <- setNames(reshape2::melt(scores.melt), c('Type', 'Exp', 'Cell', "Value"))

mix.melt <- rbind(props.melt,scores.melt)

mix.melt$Cell <- factor(mix.melt$Cell,levels = c("Monocyte","Granulocyte","Bcell", "NKcell","CD8Tcell","CD4Tcell"))

glioma_tme_sigmtx_mixed_prop <- ggplot(mix.melt, aes(fill=Cell, y=Value, x=Type)) + 
  geom_bar(position="fill", stat="identity",colour="black",width=1) + facet_grid(Exp ~ .)+
  coord_flip()+labs(x = "",y="")+theme_classic() + theme(axis.line=element_blank(),axis.text.x=element_blank(),
                                              axis.ticks=element_blank(),
                                              axis.title.x=element_blank(),
                                              axis.title.y=element_blank(),
                                              axis.text.y = element_text(hjust = 1),
                                              panel.background=element_blank(),panel.border=element_blank(),
                                              panel.grid.major=element_blank(),
                                              panel.grid.minor=element_blank(),plot.background=element_blank(),
                                              strip.background = element_blank(),
                                              strip.text.y = element_blank(),
                                              legend.text=element_text(size=20),
                                              legend.title=element_blank()) +
                                              scale_y_continuous(expand = c(0, 0),limits=c(0, 1)) +
  scale_fill_manual(values=get_palette(6))
glioma_tme_sigmtx_mixed_prop

if (useCairo) {
  Cairo::Cairo(file=paste0(images_dir,exp_name,"_mixed_sample_prop_",get_timestamp(),".png"),
               type="png", units="px", width=600, height=200, pointsize=20, dpi="auto")
  glioma_tme_sigmtx_mixed_prop
  dev.off()
}
```
